<html>

<head>
<title>WebGL Sandbox</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1"/>

<script type="text/javascript" src="gl-matrix-min.js"></script>
<script type="text/javascript" src="webgl.js"></script>
<script type="text/javascript" src="bullet-storm-const.js"></script>
<script type="text/javascript" src="bullet-storm-primitives.js"></script>
<script type="text/javascript" src="bullet-storm-input.js"></script>    
<script type="text/javascript" src="bullet-storm.js"></script>

<!-- =========================================== -->
<!--             BACKGROUND SHADERS              -->
<!-- =========================================== -->

<script id="bs.background.vs" type="x-shader/x-vertex">
    attribute vec3 a_VertexPosition;
    
    void main(void) 
    {
        gl_Position = vec4(a_VertexPosition, 1.0);
    }
</script>

<script id="bs.background.fs" type="x-shader/x-fragment">
    #ifdef GL_ES
    precision mediump float;
    #endif

    uniform float u_Time;
    uniform vec2 u_Resolution;

    const mat2 m2 = mat2(0.8, -0.6, 0.6, 0.8); 

    float cosNoise(in vec2 pos)
    {
        return 0.7*(sin(pos.x) + sin(pos.y));
    }

    float map(in vec3 pos)
    {
        vec2 q = pos.xz * 0.6;
        float h = 1.0;
            
        float s = 0.5;
        for(int i = 0; i < 8; i++)
        {
           h += s * cosNoise(q);
           s *= 0.5;
           q = m2 * q * 1.6;
        }

        h *= 4.0;

        return pos.y - h;
    }

    vec3 calcNormal(in vec3 pos)
    {
        vec3 nor;
        vec2 e = vec2(0.01,0.00001);
        nor.x = map(pos + e.xyy) - map(pos - e.xyy);
        nor.y = map(pos + e.yxy) - map(pos - e.yxy);
        nor.z = map(pos + e.yyx) - map(pos - e.yyx);
        return normalize(nor);
    }

    void main()
    {
        vec2 p = gl_FragCoord.xy / u_Resolution.xy;
        vec2 q = -1.0 + 2.0*p;
        q.x *= u_Resolution.x / u_Resolution.y; 

        vec3 ro = vec3(0.0, 30.0, - u_Time);
        vec3 rd = normalize(vec3(q.x, q.y - 2.0, -1.0));

        vec3 col = vec3(0.7, 0.8, 1.0);

        float tmax = 90.0;
        float t = 0.0;

        for(int i = 0; i < 128; i++)
        {
            vec3 pos = ro + rd * t;
            float h = map(pos);
            if(h < 0.1 || t > tmax)
            {
                break; 
            } 
            
            t += h*0.3;
        }

        vec3 light = normalize(vec3(0.1, 0.1, -0.9));

        if(t < tmax)
        {
            vec3 pos = ro + t*rd;
            vec3 nor = calcNormal(pos);

            float dif = clamp (dot(nor,light), 0.0,1.0);
            vec3 lig = vec3(1.0, 1.0,0.0)*dif;
            lig += vec3(0.1,0.2,0.3)*nor.y *2.0;
            
            vec3 mate = vec3(0.7, 0.0, 0.3); 

            mate = mix(mate, vec3(0.2,0.0,0.7), smoothstep(0.7,0.9,nor.y));
            col = lig * mate;
            
            float fog = exp(-0.00001 * t * t * t);
            col += ((1.0 - fog) * vec3(0.7,0.2,1.0));
        }

        gl_FragColor = vec4(col, 1.0);
    }
</script>

<!-- =========================================== -->
<!--                  SCENE SHADERS              -->
<!-- =========================================== -->

<script id="bs.default.vs" type="x-shader/x-vertex">
    attribute vec3 a_VertexPosition;
    attribute vec2 a_TexCoord;

    uniform mat4 u_ViewMatrix;
    uniform mat4 u_ModelMatrix;
    uniform mat4 u_ProjMatrix;
    uniform vec4 u_TintColor;

    varying vec4 v_Color;
    varying vec2 v_TexCoord;

    void main(void) 
    {
        mat4 mvpMatrix = u_ProjMatrix * u_ViewMatrix * u_ModelMatrix;
        gl_Position = mvpMatrix * vec4(a_VertexPosition, 1.0);
        v_Color = u_TintColor;
        v_TexCoord = a_TexCoord;
    }
</script>

<script id="bs.flatcolor.fs" type="x-shader/x-fragment">
    precision mediump float;

    varying vec4 v_Color;

    void main(void) 
    {
        gl_FragColor = v_Color;
    }
</script>

<script id="bs.bullet.fs" type="x-shader/x-fragment">
    precision mediump float;

    varying vec4 v_Color;
    varying vec2 v_TexCoord;

    void main(void) 
    {
        float a = 1.0 - length(vec2(1.0) - v_TexCoord.xy * 2.0);

        gl_FragColor = vec4(v_Color.rgb, a);
    }
</script>


<link rel="stylesheet" type="text/css" href="styles.css">

</head>

<body onload="BulletStorm.run();">
	<canvas id="webgl-canvas" style="border: none;" width="800" height="600"/>
</body>

</html>